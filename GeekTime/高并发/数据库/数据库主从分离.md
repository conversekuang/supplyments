数据库优化：主从分离



<img src="https://static001.geekbang.org/resource/image/26/90/2643e13598139d0964bfc40469bd8390.jpg" style="zoom:30%"></img>



主从分离：由于查询流量和写流量的请求量级存在差异化。

面对突发流量：从库扩容，读流量分配到多个库上，将负载降下来。在解决如何拦截读流量。



主从分离的核心技术点：

1. 主从复制【数据拷贝】
2. 如何保证数据库访问的改变，能够跟访问单一库是一样的。





#### 主从复制

MySQL 的主从复制是依赖于 binlog 的。

binlog就是记录 MySQL 上的所有变化并以二进制形式保存在磁盘上二进制日志文件。

主从复制就是将 binlog 中的数据从主库传输到从库上。一般这个过程是异步的，即主库上的操作不会等待 binlog 同步的完成。





主从复制过程：

主从复制的过程是这样的：首先从库在连接到主节点时会创建一个 IO 线程，用以请求主库更新的 binlog，并且把接收到的 binlog 信息写入一个叫做 relay log 的日志文件中，而主库也会创建一个 log dump 线程来发送 binlog 给从库；同时，从库还会创建一个 SQL 线程读取 relay log 中的内容，并且在从库中做回放，最终实现主从的一致性。这是一种比较常见的主从复制方式。

<img src = "https://static001.geekbang.org/resource/image/57/4d/575ef1a6dc6463e4c5a60a3752d8554d.jpg"></img>



在这个方案中，使用独立的 log dump 线程是一种异步的方式，可以避免对主库的主体更新流程产生影响，而从库在接收到信息后并不是写入从库的存储中，是写入一个 relay log，是避免写入从库实际存储会比较耗时，最终造成从库和主库延迟变长。

【比如：主库并没有因为同步binlog而不进行写操作，因为是独立的线程进行，这就是理解避免对主库的主体更新流程产生影响。同样，从库也是新建线程写入relay log，并不影响从库的读操作。设想，如果主库和从库都不再进行读写时候，只进行复制数据，那么在复制期间的读写请求是完全无法进行的。这是无法容忍的。】



> 是不是无限制地增加从库的数量就可以抵抗大量的并发呢？

​		实际上并不是的。

1. 因为随着从库数量增加，从库连接上来的 IO 线程比较多，主库也需要创建同样多的 log dump 线程来处理复制的请求，对于主库资源消耗比较高。
2. 同时受限于主库的网络带宽，主库需要和多个从库建立通信关系。

所以在实际使用中，一般一个主库最多挂 3～5 个从库。





主从复制的缺陷：

1. 主从同步的延迟。

   当主库中写入了，但是从库中并没有读取到。因为还没更新到。这样会出现异常。

<img src = "https://static001.geekbang.org/resource/image/d0/44/d06716649d3894e8c2b2bf242b1ab544.jpg"></img>



解决主从延迟的三种方法：

```
第一种方案是数据的冗余。你可以在发送消息队列时不仅仅发送微博 ID，而是发送队列处理机需要的所有微博信息，借此避免从数据库中重新查询数据。

第二种方案是使用缓存。我可以在同步写数据库的同时，也把微博的数据写入到 Memcached 缓存里面，这样队列处理机在获取微博信息的时候会优先查询缓存，这样也可以保证数据的一致性。

最后一种方案是查询主库。我可以在队列处理机中不查询从库而改为查询主库。不过，这种方式使用起来要慎重，要明确查询的量级不会很大，是在主库的可承受范围之内，否则会对主库造成比较大的压力。
```



2. debug中经常忽视的问题。

   把**从库落后的时间作为一个重点的数据库指标做监控和报警**，正常的时间是在**毫秒**级别，一旦落后的时间达到了秒级别就需要告警了。



如何访问数据库：

​	由于读写分离技术，数据库的使用方式变化，所以需要区分读操作和写操作。

​		

**为了降低实现的复杂度，业界涌现了很多数据库中间件来解决数据库的访问问题，这些中间件可以分为两类。**



1. 以代码形式嵌入在程序中。

   淘宝的 TDDL（ Taobao Distributed Data Layer）为代表，Sharding-JDBC 

2. 以单独的部署中间件方式存在。

   如早期阿里巴巴开源的 Cobar，基于 Cobar 开发出来的 Mycat，360 开源的 Atlas，美团开源的基于 Atlas 开发的 DBProxy 等等。

   优点：

   - 一般使用标准的 MySQL 通信协议，所以可以很好地支持多语言
   - 适合大中团队

   缺点：

   - 需要跨两次网络，性能损耗。

   <img src = "https://static001.geekbang.org/resource/image/e7/ff/e7e9430cbcb104764529ca5e01e6b3ff.jpg"></img>

   **在使用任何中间件的时候一定要保证对于中间件有足够深入的了解，否则一旦出了问题没法快速地解决就悲剧了**





我们可以把主从复制引申为存储节点之间互相复制存储数据的技术，它可以实现数据的冗余，以达到备份和提升横向扩展能力的作用。在使用主从复制这个技术点时，你一般会考虑两个问题：

1. 主从的一致性和写入性能的权衡，如果你要保证所有从节点都写入成功，那么写入性能一定会受影响；如果你只写入主节点就返回成功，那么从节点就有可能出现数据同步失败的情况，从而造成主从不一致，而在互联网的项目中，我们一般会优先考虑性能而不是数据的强一致性。
2. 主从的延迟问题，很多诡异的读取不到数据的问题都可能会和它有关，如果你遇到这类问题不妨先看看主从延迟的数据。



Mysql，Redis，ES，HDFS等其实都是复制数据，在一致性和延迟上的方案不同。但是思路是一样的。