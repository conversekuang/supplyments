



分库分表的时候查询必须要带分区键。

选择什么字段选择主键？

- 业务字段作为主键
- 生成的唯一ID作为主键



**更倾向于使用生成的 ID 作为数据库的主键**。

业务字段的缺点：

- 采用身份证方式，隐私性问题
- 一个人可以有多个emai和手机号，修改手机号会存在问题。外键



唯一ID：

- 生成可以随便引用

---

单库单表的场景下，我们可以使用数据库的自增字段作为 ID，因为这样最简单，对于开发人员来说也是透明的。但是当数据库分库分表后，使用自增字段就无法保证 ID 的全局唯一性了。



**分库分表存在的问题**:

想象一下，当我们分库分表之后，同一个逻辑表的数据被分布到多个库中，这时如果使用数据库自增字段作为主键，那么只能保证在这个库中是唯一的，无法保证全局的唯一性。那么假如你来设计用户系统的时候，使用自增 ID 作为用户 ID，就可能出现两个用户有两个相同的 ID，这是不可接受的，那么你要怎么做呢？.



**解决方法**：

搭建发号器服务来生成全局唯一的 ID。



**发号器**：

我主要使用的是变种的 Snowflake 算法来生成业务需要的 ID 的，也是运用它去解决 ID 全局唯一性的问题



特点是：生成的 ID 最好具有单调递增性，也就是有序的。

- 写入磁盘方便
- 和时间有关
- 具备业务含义

---

UUID：通用唯一识别码（Universally Unique Identifier）

UUID是一个128比特的数值，最后，UUID 是由 32 个 16 进制数字组成的字符串，如果作为数据库主键使用比较耗费空间。

UUID 的目的是让[分布式系统](https://baike.baidu.com/item/分布式系统)中的所有元素，都能有唯一的辨识资讯，而不需要透过中央控制端来做辨识资讯的指定。



首先，生成的 ID 最好具有单调递增性，也就是有序的，而 UUID 不具备这个特点

---



Snowflake 的核心思想是将 64bit 的二进制数字分成若干部分，每一部分都存储有特定含义的数据，比如说时间戳、机器 ID、序列号等等，最终生成全局唯一的有序 ID。它的标准算法是这样的：



<img src = "https://static001.geekbang.org/resource/image/2d/8d/2dee7e8e227a339f8f3cb6e7b47c0c8d.jpg"></img>

从上面这张图中我们可以看到，

**41 位的时间戳**：可以支撑 pow(2,41)/1000/60/60/24/365 年，约等于 69 年，对于一个系统是足够了。

**10 位的机器 ID** ： 2～3 位的 IDC 标示（可以支撑 4 个或者 8 个 IDC 机房）和 7～8 位的机器 ID（支持 128-256 台机器）【2^7 = 128】

**12 位的序列号**：代表着每个节点每毫秒最多可以生成 4096 的 ID。【2^12 = 4096】



可根据业务对算法进行修改。



一般来说我们会有两种算法的实现方式：

- 嵌入业务代码

  加长机器ID的位数支持更多的服务器。借助zk保证获得唯一的机器ID。

- 独立服务



缺点：

Snowflake 算法设计得非常简单且巧妙，性能上也足够高效，同时也能够生成具有全局唯一性、单调递增性和有业务含义的 ID，但是它也有一些缺点，其中最大的缺点就是它依赖于系统的时间戳，一旦系统时间不准，就有可能生成重复的 ID。所以如果我们发现系统时钟不准，就可以让发号器暂时拒绝发号，直到时钟准确为止。



---

补充：



